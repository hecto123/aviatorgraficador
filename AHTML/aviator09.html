<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cascada tipo Aviator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@4.1.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; }
        .inputs { margin-bottom: 10px; }
        .inputs input { width: 120px; margin-right: 5px; }
        #semillas-container {
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            margin: 20px 0 20px 0;
            min-height: 60px;
            user-select: none;
            flex-wrap: wrap;
            overflow-x: auto;
            max-width: 1000px;
        }
        .semilla {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            margin-right: 8px;
            margin-bottom: 8px;
            border-radius: 50%;
            color: #fff;
            font-size: 1.2em;
            font-family: Arial, sans-serif;
            font-weight: bold;
            box-shadow: 1px 1px 6px rgba(0,0,0,0.13);
            transition: background 0.2s;
            position: relative;
        }
        .resultado {
            font-size: 0.9em;
            color: #333;
            background: #fff;
            border-radius: 8px;
            padding: 2px 6px;
            margin-top: 2px;
            margin-bottom: -10px;
            border: 1px solid #ccc;
        }
        .azul { background: #1976d2; }
        .violet { background: #8e24aa; }
        .fuccia { background: #e040fb; }
        .borrar-btn {
            margin-left: 10px;
            padding: 6px 16px;
            background: #e53935;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }
        .borrar-btn:hover { background: #b71c1c; }
        .cerrar {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #fff;
            color: #e53935;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 16px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            border: 1px solid #e53935;
            font-weight: bold;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #grafico-container {
            width: 100%;
            overflow-x: auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            padding: 10px 0;
            max-width: 1000px;
            margin: auto;
        }
        #grafico {
            min-width: 1200px;
            height: 500px;
            display: block;
        }
        #estadisticas {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            padding: 16px;
            max-width: 1000px;
            margin: 24px auto 0 auto;
            font-size: 1.1em;
        }
        .prediccion {
            font-weight: bold;
            color: #1976d2;
            font-size: 1.2em;
        }
        #alertas {
            max-width: 1000px;
            margin: 16px auto 0 auto;
        }
    </style>
</head>
<body>
    <h3>
        Ingresa el valor de cada ronda y haz clic en "Agregar" o presiona Enter.<br>
        Cada semilla muestra el valor y debajo el resultado de la fórmula.<br>
        El gráfico muestra la suma acumulada de esos resultados (tipo cascada).<br>
        <span style="color:#1976d2">Menor a 2: azul, 2 a 5: violeta, mayor a 5: fuccia.</span>
    </h3>
    <div class="inputs">
        <input type="number" id="valor" placeholder="Valor de ronda" step="any">
        <button onclick="agregarDato()" id="agregar-btn">Agregar</button>
        <button class="borrar-btn" onclick="borrarSemilla()">Borrar semilla</button>
    </div>
    <div id="semillas-container"></div>
    <div id="grafico-container">
        <canvas id="grafico" width="2000" height="500"></canvas>
    </div>
    <div id="estadisticas"></div>
    <div id="alertas"></div>
    <script>
        let datos = [];
        let chart;

        // Configura aquí los niveles de alerta que quieras
        const nivelesAlerta = [
            { nivel: 1.5, mensaje: "¡Entrada a cuota 1.5 detectada!", color: "red" },
            { nivel: 1.7, mensaje: "¡Entrada a cuota 1.7 detectada!", color: "#1976d2" },
            { nivel: 2, mensaje: "¡Entrada a cuota 2.0 detectada!", color: "green" }
        ];
        let alertasMostradas = {};

        function colorSemilla(valor) {
            if (valor > 5) return 'fuccia';
            if (valor >= 2) return 'violet';
            return 'azul';
        }

        function resultadoFormula(valor) {
            if (valor === "" || valor === null || isNaN(valor)) return "";
            return valor < 2 ? -1 : 1;
        }

        function acumuladoResultados() {
            let acumulado = 0;
            let arr = [];
            for (let v of datos) {
                let r = resultadoFormula(v);
                acumulado += (typeof r === "number" ? r : 0);
                arr.push(acumulado);
            }
            return arr;
        }

        // Calcula la pendiente de la regresión lineal de los últimos 5 acumulados
        function calcularPendiente() {
            const acumulados = acumuladoResultados();
            if (acumulados.length < 2) return 0;
            let n = Math.min(5, acumulados.length);
            let xs = [], ys = [];
            for (let i = acumulados.length - n; i < acumulados.length; i++) {
                xs.push(i + 1);
                ys.push(acumulados[i]);
            }
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < n; i++) {
                sumX += xs[i];
                sumY += ys[i];
                sumXY += xs[i] * ys[i];
                sumXX += xs[i] * xs[i];
            }
            let m = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            return m;
        }

        // Predicción avanzada: regresión lineal sobre los últimos 5 acumulados
        function prediccionProximaRonda() {
            const acumulados = acumuladoResultados();
            if (acumulados.length < 3) return "Sin datos suficientes";
            let n = Math.min(5, acumulados.length);
            let xs = [], ys = [];
            for (let i = acumulados.length - n; i < acumulados.length; i++) {
                xs.push(i + 1);
                ys.push(acumulados[i]);
            }
            // Regresión lineal simple
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < n; i++) {
                sumX += xs[i];
                sumY += ys[i];
                sumXY += xs[i] * ys[i];
                sumXX += xs[i] * xs[i];
            }
            let m = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            let b = (sumY - m * sumX) / n;
            let nextX = xs[n - 1] + 1;
            let pred = m * nextX + b;
            pred = Math.round(pred * 100) / 100;
            if (ys[n - 1] < 1.5 && pred >= 1.7) {
                return `¡Probable cruce de 1.7 en la próxima ronda! (Predicción: ${pred})`;
            } else if (ys[n - 1] < 1.5 && pred >= 1.5) {
                return `¡Probable cruce de 1.5 en la próxima ronda! (Predicción: ${pred})`;
            } else if (pred < 2) {
                return `Tendencia a menor a 2 (Predicción: ${pred})`;
            } else if (pred >= 2) {
                return `Tendencia a mayor o igual a 2 (Predicción: ${pred})`;
            } else {
                return `Sin tendencia clara (Predicción: ${pred})`;
            }
        }

        function calcularEstadisticas() {
            if (datos.length === 0) return {
                rondas: 0,
                promedio: 0,
                menos2: 0,
                masIgual2: 0,
                ultimos: [],
                prediccion: "Sin datos suficientes"
            };
            let suma = 0, menos2 = 0, masIgual2 = 0;
            let ultimos = datos.slice(-5);
            datos.forEach(v => {
                suma += v;
                if (v < 2) menos2++;
                else masIgual2++;
            });
            return {
                rondas: datos.length,
                promedio: (suma / datos.length).toFixed(2),
                menos2,
                masIgual2,
                ultimos,
                prediccion: prediccionProximaRonda()
            };
        }

        function mostrarEstadisticas() {
            const est = calcularEstadisticas();
            document.getElementById('estadisticas').innerHTML = `
                <b>Estadísticas:</b><br>
                Rondas: ${est.rondas}<br>
                Promedio: ${est.promedio}<br>
                Menores a 2: ${est.menos2}<br>
                Mayores o iguales a 2: ${est.masIgual2}<br>
                Últimos 5 valores: ${est.ultimos.join(', ')}<br>
                <span class="prediccion">Predicción próxima ronda: ${est.prediccion}</span>
            `;
        }

        function mostrarAlertas(alertas) {
            const alertasDiv = document.getElementById('alertas');
            alertasDiv.innerHTML = '';
            alertas.forEach(a => {
                const div = document.createElement('div');
                div.style.background = a.color;
                div.style.color = "#fff";
                div.style.padding = "10px";
                div.style.marginBottom = "8px";
                div.style.borderRadius = "6px";
                div.style.fontWeight = "bold";
                div.textContent = a.mensaje;
                alertasDiv.appendChild(div);
            });
        }

        function actualizarSemillas() {
            const semillasDiv = document.getElementById('semillas-container');
            semillasDiv.innerHTML = '';
            // Solo mostrar las últimas 50 semillas
            const start = Math.max(0, datos.length - 50);
            const datosMostrar = datos.slice(start);
            datosMostrar.forEach((valor, idx) => {
                const semilla = document.createElement('div');
                semilla.className = 'semilla ' + colorSemilla(valor);

                const valorSpan = document.createElement('span');
                valorSpan.textContent = valor;
                semilla.appendChild(valorSpan);

                const res = document.createElement('span');
                res.className = 'resultado';
                res.textContent = resultadoFormula(valor);
                semilla.appendChild(res);

                const cerrar = document.createElement('span');
                cerrar.className = 'cerrar';
                cerrar.textContent = '×';
                cerrar.title = 'Borrar este valor';
                cerrar.onclick = function(e) {
                    e.stopPropagation();
                    // El índice real en datos es start + idx
                    datos.splice(start + idx, 1);
                    actualizarSemillas();
                    actualizarGrafico();
                    mostrarEstadisticas();
                    document.getElementById('valor').value = '';
                    document.getElementById('valor').focus();
                    // Reset alertas
                    alertasMostradas = {};
                    mostrarAlertas([]);
                };
                semilla.appendChild(cerrar);

                semillasDiv.appendChild(semilla);
            });
        }

        function actualizarGrafico() {
            const ctx = document.getElementById('grafico').getContext('2d');
            if (chart) chart.destroy();
            const labels = datos.length ? datos.map((_, i) => i + 1) : [1,2,3,4,5];
            const data = datos.length ? acumuladoResultados() : [0,0,0,0,0];

            // Calcula la pendiente para determinar el color
            const pendiente = calcularPendiente();
            const colorLinea = pendiente >= 0 ? 'green' : 'red';
            const colorFondo = pendiente >= 0 ? 'rgba(76,175,80,0.13)' : 'rgba(244,67,54,0.13)';

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Acumulado fórmula',
                        data: data,
                        borderColor: colorLinea,
                        backgroundColor: colorFondo,
                        fill: true,
                        tension: 0.6,
                        pointRadius: 8,
                        pointBackgroundColor: colorLinea,
                        pointBorderWidth: 2,
                        pointBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Acumulado: ${context.parsed.y}`;
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                soporte15: {
                                    type: 'line',
                                    yMin: 1.5,
                                    yMax: 1.5,
                                    borderColor: 'red',
                                    borderWidth: 1,
                                    borderDash: [4, 4],
                                    label: {
                                        content: 'Soporte 1.5',
                                        enabled: true,
                                        position: 'end',
                                        backgroundColor: 'red',
                                        color: '#fff',
                                        font: { weight: 'bold', size: 10 }
                                    }
                                },
                                soporte17: {
                                    type: 'line',
                                    yMin: 1.7,
                                    yMax: 1.7,
                                    borderColor: '#1976d2',
                                    borderWidth: 1,
                                    borderDash: [4, 4],
                                    label: {
                                        content: 'Soporte 1.7',
                                        enabled: true,
                                        position: 'end',
                                        backgroundColor: '#1976d2',
                                        color: '#fff',
                                        font: { weight: 'bold', size: 10 }
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Ronda', color: '#333' },
                            grid: { color: '#eee' },
                            ticks: { color: '#666' }
                        },
                        y: {
                            title: { display: true, text: 'Acumulado', color: '#333' },
                            grid: { color: '#eee' },
                            ticks: { color: '#666' },
                            beginAtZero: true
                        }
                    },
                    pan: {
                        enabled: true,
                        mode: 'x',
                        speed: 10,
                        threshold: 10
                    },
                    zoom: {
                        enabled: true,
                        mode: 'x',
                        drag: true
                    }
                }
            });
        }

        function agregarDato() {
            const v = parseFloat(document.getElementById('valor').value);
            if (isNaN(v)) {
                alert('Por favor, ingresa un valor.');
                return;
            }
            datos.push(v);
            actualizarSemillas();
            actualizarGrafico();
            mostrarEstadisticas();

            const acumulados = acumuladoResultados();
            let nuevasAlertas = [];

            nivelesAlerta.forEach(nivelObj => {
                const nivel = nivelObj.nivel;
                // Detecta cruce ascendente
                if (
                    (acumulados.length === 1 && acumulados[0] >= nivel && !alertasMostradas[nivel]) ||
                    (acumulados.length > 1 && acumulados[acumulados.length - 2] < nivel && acumulados[acumulados.length - 1] >= nivel && !alertasMostradas[nivel])
                ) {
                    nuevasAlertas.push(nivelObj);
                    alertasMostradas[nivel] = true;
                }
                // Reset si baja
                if (acumulados[acumulados.length - 1] < nivel) {
                    alertasMostradas[nivel] = false;
                }
            });

            mostrarAlertas(nuevasAlertas);

            document.getElementById('valor').value = '';
            document.getElementById('valor').focus();
        }

        function borrarSemilla() {
            if (datos.length > 0) {
                datos.pop();
                actualizarSemillas();
                actualizarGrafico();
                mostrarEstadisticas();
            }
            document.getElementById('valor').value = '';
            document.getElementById('valor').focus();
            alertasMostradas = {};
            mostrarAlertas([]);
        }

        document.getElementById('valor').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                agregarDato();
            }
            if ((event.key === 'Backspace' || event.key === 'Delete') && this.value === '') {
                borrarSemilla();
                event.preventDefault();
            }
        });

        document.addEventListener('keydown', function(event) {
            const input = document.getElementById('valor');
            if ((event.key === 'Backspace' || event.key === 'Delete') && document.activeElement !== input) {
                borrarSemilla();
                event.preventDefault();
            }
        });

        // Inicializar
        actualizarSemillas();
        actualizarGrafico();
        mostrarEstadisticas();
    </script>
</body>
</html><!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Cascada tipo Aviator</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@4.1.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; background: #f7f7f7; }
        .inputs { margin-bottom: 10px; }
        .inputs input { width: 120px; margin-right: 5px; }
        #semillas-container {
            display: flex;
            flex-direction: row;
            align-items: flex-end;
            margin: 20px 0 20px 0;
            min-height: 60px;
            user-select: none;
            flex-wrap: wrap;
            overflow-x: auto;
            max-width: 1000px;
        }
        .semilla {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            margin-right: 8px;
            margin-bottom: 8px;
            border-radius: 50%;
            color: #fff;
            font-size: 1.2em;
            font-family: Arial, sans-serif;
            font-weight: bold;
            box-shadow: 1px 1px 6px rgba(0,0,0,0.13);
            transition: background 0.2s;
            position: relative;
        }
        .resultado {
            font-size: 0.9em;
            color: #333;
            background: #fff;
            border-radius: 8px;
            padding: 2px 6px;
            margin-top: 2px;
            margin-bottom: -10px;
            border: 1px solid #ccc;
        }
        .azul { background: #1976d2; }
        .violet { background: #8e24aa; }
        .fuccia { background: #e040fb; }
        .borrar-btn {
            margin-left: 10px;
            padding: 6px 16px;
            background: #e53935;
            color: #fff;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }
        .borrar-btn:hover { background: #b71c1c; }
        .cerrar {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #fff;
            color: #e53935;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 16px;
            line-height: 20px;
            text-align: center;
            cursor: pointer;
            border: 1px solid #e53935;
            font-weight: bold;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #grafico-container {
            width: 100%;
            overflow-x: auto;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            padding: 10px 0;
            max-width: 1000px;
            margin: auto;
        }
        #grafico {
            min-width: 1200px;
            height: 500px;
            display: block;
        }
        #estadisticas {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            padding: 16px;
            max-width: 1000px;
            margin: 24px auto 0 auto;
            font-size: 1.1em;
        }
        .prediccion {
            font-weight: bold;
            color: #1976d2;
            font-size: 1.2em;
        }
        #alertas {
            max-width: 1000px;
            margin: 16px auto 0 auto;
        }
    </style>
</head>
<body>
    <h3>
        Ingresa el valor de cada ronda y haz clic en "Agregar" o presiona Enter.<br>
        Cada semilla muestra el valor y debajo el resultado de la fórmula.<br>
        El gráfico muestra la suma acumulada de esos resultados (tipo cascada).<br>
        <span style="color:#1976d2">Menor a 2: azul, 2 a 5: violeta, mayor a 5: fuccia.</span>
    </h3>
    <div class="inputs">
        <input type="number" id="valor" placeholder="Valor de ronda" step="any">
        <button onclick="agregarDato()" id="agregar-btn">Agregar</button>
        <button class="borrar-btn" onclick="borrarSemilla()">Borrar semilla</button>
    </div>
    <div id="semillas-container"></div>
    <div id="grafico-container">
        <canvas id="grafico" width="2000" height="500"></canvas>
    </div>
    <div id="estadisticas"></div>
    <div id="alertas"></div>
    <script>
        let datos = [];
        let chart;

        // Configura aquí los niveles de alerta que quieras
        const nivelesAlerta = [
            { nivel: 1.5, mensaje: "¡Entrada a cuota 1.5 detectada!", color: "red" },
            { nivel: 1.7, mensaje: "¡Entrada a cuota 1.7 detectada!", color: "#1976d2" },
            { nivel: 2, mensaje: "¡Entrada a cuota 2.0 detectada!", color: "green" }
        ];
        let alertasMostradas = {};

        function colorSemilla(valor) {
            if (valor > 5) return 'fuccia';
            if (valor >= 2) return 'violet';
            return 'azul';
        }

        function resultadoFormula(valor) {
            if (valor === "" || valor === null || isNaN(valor)) return "";
            return valor < 2 ? -1 : 1;
        }

        function acumuladoResultados() {
            let acumulado = 0;
            let arr = [];
            for (let v of datos) {
                let r = resultadoFormula(v);
                acumulado += (typeof r === "number" ? r : 0);
                arr.push(acumulado);
            }
            return arr;
        }

        // Calcula la pendiente de la regresión lineal de los últimos 5 acumulados
        function calcularPendiente() {
            const acumulados = acumuladoResultados();
            if (acumulados.length < 2) return 0;
            let n = Math.min(5, acumulados.length);
            let xs = [], ys = [];
            for (let i = acumulados.length - n; i < acumulados.length; i++) {
                xs.push(i + 1);
                ys.push(acumulados[i]);
            }
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < n; i++) {
                sumX += xs[i];
                sumY += ys[i];
                sumXY += xs[i] * ys[i];
                sumXX += xs[i] * xs[i];
            }
            let m = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            return m;
        }

        // Predicción avanzada: regresión lineal sobre los últimos 5 acumulados
        function prediccionProximaRonda() {
            const acumulados = acumuladoResultados();
            if (acumulados.length < 3) return "Sin datos suficientes";
            let n = Math.min(5, acumulados.length);
            let xs = [], ys = [];
            for (let i = acumulados.length - n; i < acumulados.length; i++) {
                xs.push(i + 1);
                ys.push(acumulados[i]);
            }
            // Regresión lineal simple
            let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;
            for (let i = 0; i < n; i++) {
                sumX += xs[i];
                sumY += ys[i];
                sumXY += xs[i] * ys[i];
                sumXX += xs[i] * xs[i];
            }
            let m = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
            let b = (sumY - m * sumX) / n;
            let nextX = xs[n - 1] + 1;
            let pred = m * nextX + b;
            pred = Math.round(pred * 100) / 100;
            if (ys[n - 1] < 1.5 && pred >= 1.7) {
                return `¡Probable cruce de 1.7 en la próxima ronda! (Predicción: ${pred})`;
            } else if (ys[n - 1] < 1.5 && pred >= 1.5) {
                return `¡Probable cruce de 1.5 en la próxima ronda! (Predicción: ${pred})`;
            } else if (pred < 2) {
                return `Tendencia a menor a 2 (Predicción: ${pred})`;
            } else if (pred >= 2) {
                return `Tendencia a mayor o igual a 2 (Predicción: ${pred})`;
            } else {
                return `Sin tendencia clara (Predicción: ${pred})`;
            }
        }

        function calcularEstadisticas() {
            if (datos.length === 0) return {
                rondas: 0,
                promedio: 0,
                menos2: 0,
                masIgual2: 0,
                ultimos: [],
                prediccion: "Sin datos suficientes"
            };
            let suma = 0, menos2 = 0, masIgual2 = 0;
            let ultimos = datos.slice(-5);
            datos.forEach(v => {
                suma += v;
                if (v < 2) menos2++;
                else masIgual2++;
            });
            return {
                rondas: datos.length,
                promedio: (suma / datos.length).toFixed(2),
                menos2,
                masIgual2,
                ultimos,
                prediccion: prediccionProximaRonda()
            };
        }

        function mostrarEstadisticas() {
            const est = calcularEstadisticas();
            document.getElementById('estadisticas').innerHTML = `
                <b>Estadísticas:</b><br>
                Rondas: ${est.rondas}<br>
                Promedio: ${est.promedio}<br>
                Menores a 2: ${est.menos2}<br>
                Mayores o iguales a 2: ${est.masIgual2}<br>
                Últimos 5 valores: ${est.ultimos.join(', ')}<br>
                <span class="prediccion">Predicción próxima ronda: ${est.prediccion}</span>
            `;
        }

        function mostrarAlertas(alertas) {
            const alertasDiv = document.getElementById('alertas');
            alertasDiv.innerHTML = '';
            alertas.forEach(a => {
                const div = document.createElement('div');
                div.style.background = a.color;
                div.style.color = "#fff";
                div.style.padding = "10px";
                div.style.marginBottom = "8px";
                div.style.borderRadius = "6px";
                div.style.fontWeight = "bold";
                div.textContent = a.mensaje;
                alertasDiv.appendChild(div);
            });
        }

        function actualizarSemillas() {
            const semillasDiv = document.getElementById('semillas-container');
            semillasDiv.innerHTML = '';
            // Solo mostrar las últimas 50 semillas
            const start = Math.max(0, datos.length - 50);
            const datosMostrar = datos.slice(start);
            datosMostrar.forEach((valor, idx) => {
                const semilla = document.createElement('div');
                semilla.className = 'semilla ' + colorSemilla(valor);

                const valorSpan = document.createElement('span');
                valorSpan.textContent = valor;
                semilla.appendChild(valorSpan);

                const res = document.createElement('span');
                res.className = 'resultado';
                res.textContent = resultadoFormula(valor);
                semilla.appendChild(res);

                const cerrar = document.createElement('span');
                cerrar.className = 'cerrar';
                cerrar.textContent = '×';
                cerrar.title = 'Borrar este valor';
                cerrar.onclick = function(e) {
                    e.stopPropagation();
                    // El índice real en datos es start + idx
                    datos.splice(start + idx, 1);
                    actualizarSemillas();
                    actualizarGrafico();
                    mostrarEstadisticas();
                    document.getElementById('valor').value = '';
                    document.getElementById('valor').focus();
                    // Reset alertas
                    alertasMostradas = {};
                    mostrarAlertas([]);
                };
                semilla.appendChild(cerrar);

                semillasDiv.appendChild(semilla);
            });
        }

        function actualizarGrafico() {
            const ctx = document.getElementById('grafico').getContext('2d');
            if (chart) chart.destroy();
            const labels = datos.length ? datos.map((_, i) => i + 1) : [1,2,3,4,5];
            const data = datos.length ? acumuladoResultados() : [0,0,0,0,0];

            // Calcula la pendiente para determinar el color
            const pendiente = calcularPendiente();
            const colorLinea = pendiente >= 0 ? 'green' : 'red';
            const colorFondo = pendiente >= 0 ? 'rgba(76,175,80,0.13)' : 'rgba(244,67,54,0.13)';

            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Acumulado fórmula',
                        data: data,
                        borderColor: colorLinea,
                        backgroundColor: colorFondo,
                        fill: true,
                        tension: 0.6,
                        pointRadius: 8,
                        pointBackgroundColor: colorLinea,
                        pointBorderWidth: 2,
                        pointBorderColor: '#fff'
                    }]
                },
                options: {
                    responsive: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Acumulado: ${context.parsed.y}`;
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                soporte15: {
                                    type: 'line',
                                    yMin: 1.5,
                                    yMax: 1.5,
                                    borderColor: 'red',
                                    borderWidth: 1,
                                    borderDash: [4, 4],
                                    label: {
                                        content: 'Soporte 1.5',
                                        enabled: true,
                                        position: 'end',
                                        backgroundColor: 'red',
                                        color: '#fff',
                                        font: { weight: 'bold', size: 10 }
                                    }
                                },
                                soporte17: {
                                    type: 'line',
                                    yMin: 1.7,
                                    yMax: 1.7,
                                    borderColor: '#1976d2',
                                    borderWidth: 1,
                                    borderDash: [4, 4],
                                    label: {
                                        content: 'Soporte 1.7',
                                        enabled: true,
                                        position: 'end',
                                        backgroundColor: '#1976d2',
                                        color: '#fff',
                                        font: { weight: 'bold', size: 10 }
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Ronda', color: '#333' },
                            grid: { color: '#eee' },
                            ticks: { color: '#666' }
                        },
                        y: {
                            title: { display: true, text: 'Acumulado', color: '#333' },
                            grid: { color: '#eee' },
                            ticks: { color: '#666' },
                            beginAtZero: true
                        }
                    },
                    pan: {
                        enabled: true,
                        mode: 'x',
                        speed: 10,
                        threshold: 10
                    },
                    zoom: {
                        enabled: true,
                        mode: 'x',
                        drag: true
                    }
                }
            });
        }

        function agregarDato() {
            const v = parseFloat(document.getElementById('valor').value);
            if (isNaN(v)) {
                alert('Por favor, ingresa un valor.');
                return;
            }
            datos.push(v);
            actualizarSemillas();
            actualizarGrafico();
            mostrarEstadisticas();

            const acumulados = acumuladoResultados();
            let nuevasAlertas = [];

            nivelesAlerta.forEach(nivelObj => {
                const nivel = nivelObj.nivel;
                // Detecta cruce ascendente
                if (
                    (acumulados.length === 1 && acumulados[0] >= nivel && !alertasMostradas[nivel]) ||
                    (acumulados.length > 1 && acumulados[acumulados.length - 2] < nivel && acumulados[acumulados.length - 1] >= nivel && !alertasMostradas[nivel])
                ) {
                    nuevasAlertas.push(nivelObj);
                    alertasMostradas[nivel] = true;
                }
                // Reset si baja
                if (acumulados[acumulados.length - 1] < nivel) {
                    alertasMostradas[nivel] = false;
                }
            });

            mostrarAlertas(nuevasAlertas);

            document.getElementById('valor').value = '';
            document.getElementById('valor').focus();
        }

        function borrarSemilla() {
            if (datos.length > 0) {
                datos.pop();
                actualizarSemillas();
                actualizarGrafico();
                mostrarEstadisticas();
            }
            document.getElementById('valor').value = '';
            document.getElementById('valor').focus();
            alertasMostradas = {};
            mostrarAlertas([]);
        }

        document.getElementById('valor').addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                agregarDato();
            }
            if ((event.key === 'Backspace' || event.key === 'Delete') && this.value === '') {
                borrarSemilla();
                event.preventDefault();
            }
        });

        document.addEventListener('keydown', function(event) {
            const input = document.getElementById('valor');
            if ((event.key === 'Backspace' || event.key === 'Delete') && document.activeElement !== input) {
                borrarSemilla();
                event.preventDefault();
            }
        });

        // Inicializar
        actualizarSemillas();
        actualizarGrafico();
        mostrarEstadisticas();
    </script>
</body>
</html>